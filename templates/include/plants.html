{% extends "base.html" %}

{% block content %}
<section class="bg-green-900">
    <div class="flex flex-col items-center gap-3 text-center mb-10 md:mb-20">
        <h2 class="title">Your Choice Plant</h2>
        <p class="max-w-2xl">Follow instructions for more</p>
        
        <!-- Conditionally show search bar only on shop page -->
        {% if current_path == '/shop/' %}
        <div class="w-full flex justify-center my-5">
            <input type="text" placeholder="Search plants..." class="w-1/2 p-2 border border-gray-300 rounded">
        </div>
        {% endif %}
    </div>

    <div class="container w-full grid grid-cols-1 gap-x-8 gap-y-36 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4">
        {% for plant in plants %}
        <div class="card bg-green-950 p-10 pt-24 rounded-md relative">
            <img class="w-56 absolute -top-5 left-1/2 transform -translate-x-1/2 -translate-y-1/2 duration-500" src="{{ plant.image.url }}" alt="{{ plant.common_name }}">
            <p class="italic">{{ plant.scientific_name }}</p>
            <h3>{{ plant.common_name }}</h3>
            <div class="text-yellow-500 text-xs py-3">
                {% for i in "01234" %}
                    {% if forloop.counter <= plant.rating %}
                        <i class="fi fi-sc-star"></i>
                    {% else %}
                        <i class="fi fi-rr-star text-gray-300"></i>
                    {% endif %}
                {% endfor %}
            </div>
            <div class="flex items-center justify-between">
                <p class="text-xl">{{ plant.price }} RM</p>
                <button class="bg-yellow-500 px-2 py-1 rounded-sm text-xl add-to-cart" data-plant-id="{{ plant.id }}">
                    <i class="fi fi-rr-shopping-cart"></i>
                </button>
            </div>
        </div>
        {% endfor %}
    </div>

    <!-- Conditionally add pagination only on shop page -->
    {% if current_path == '/shop/' %}
    <div class="flex justify-center mt-8">
        <nav aria-label="Page navigation">
            <ul class="inline-flex items-center -space-x-px">
                {% if page_obj.has_previous %}
                <li>
                    <a href="?page=1" class="px-3 py-2 mx-1 text-sm font-medium text-gray-900 bg-white border border-gray-300 rounded-l-lg hover:bg-gray-100 hover:text-yellow-500">First</a>
                </li>
                <li>
                    <a href="?page={{ page_obj.previous_page_number }}" class="px-3 py-2 mx-1 text-sm font-medium text-gray-900 bg-white border border-gray-300 hover:bg-gray-100 hover:text-yellow-500">Previous</a>
                </li>
                {% endif %}

                {% for num in page_obj.paginator.page_range %}
                <li>
                    <a href="?page={{ num }}" class="px-3 py-2 mx-1 text-sm font-medium border border-gray-300 {% if page_obj.number == num %}bg-yellow-500 text-white{% else %}bg-white text-gray-900{% endif %} hover:bg-gray-100 hover:text-yellow-500">
                        {{ num }}
                    </a>
                </li>
                {% endfor %}

                {% if page_obj.has_next %}
                <li>
                    <a href="?page={{ page_obj.next_page_number }}" class="px-3 py-2 mx-1 text-sm font-medium text-gray-900 bg-white border border-gray-300 hover:bg-gray-100 hover:text-yellow-500">Next</a>
                </li>
                <li>
                    <a href="?page={{ page_obj.paginator.num_pages }}" class="px-3 py-2 mx-1 text-sm font-medium text-gray-900 bg-white border border-gray-300 rounded-r-lg hover:bg-gray-100 hover:text-yellow-500">Last</a>
                </li>
                {% endif %}
            </ul>
        </nav>
    </div>
    {% endif %}
</section>

<script>
    document.addEventListener('DOMContentLoaded', function() {
      
        function setCookie(name, value, days) {
            let expires = "";
            if (days) {
                let date = new Date();
                date.setTime(date.getTime() + (days * 24 * 60 * 60 * 1000));
                expires = "; expires=" + date.toUTCString();
            }
            document.cookie = name + "=" + (value || "") + expires + "; path=/";
        }

        
        function getCookie(name) {
            let nameEQ = name + "=";
            let ca = document.cookie.split(';');
            for (let i = 0; i < ca.length; i++) {
                let c = ca[i];
                while (c.charAt(0) === ' ') c = c.substring(1, c.length);
                if (c.indexOf(nameEQ) === 0) return c.substring(nameEQ.length, c.length);
            }
            return null;
        }

        
        function updateCartBadge() {
            let cart = JSON.parse(getCookie('cart')) || {};
            console.log('Cart:', cart); 
            let totalQuantity = Object.values(cart).reduce((acc, quantity) => acc + quantity, 0);
            console.log('Total Quantity:', totalQuantity);  

            let badgeElement = document.getElementById('cart-badge');
            if (badgeElement) {
                badgeElement.textContent = totalQuantity;
                console.log('Updated Badge Content:', badgeElement.textContent);  
            } else {
                console.error('Cart badge element not found');  
            }
        }

       
        updateCartBadge();

        
        document.querySelectorAll('.add-to-cart').forEach(button => {
            button.addEventListener('click', function() {
                const plantId = this.getAttribute('data-plant-id');
                console.log(plantId)
                let cart = JSON.parse(getCookie('cart')) || {};
                console.log(cart)
                if (cart[plantId]) {
                    cart[plantId] += 1;  
                } else {
                    cart[plantId] = 1; 
                }

                setCookie('cart', JSON.stringify(cart), 7); 

               
                updateCartBadge();
            });
        });

      
        document.getElementById('search').addEventListener('input', function() {
            let query = this.value.toLowerCase();
            document.querySelectorAll('.card').forEach(card => {
                let plantName = card.querySelector('h3').textContent.toLowerCase();
                if (plantName.includes(query)) {
                    card.style.display = '';
                } else {
                    card.style.display = 'none';
                }
            });
        });
    });
</script>
{% endblock %}
