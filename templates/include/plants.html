{% extends "base.html" %}

{% block content %}
<section class="bg-green-900">
    <div class="flex flex-col items-center gap-3 text-center mb-10 md:mb-20">
        <h2 class="title">Your Choice Plant</h2>
        <p class="max-w-2xl">Follow instructions for more</p>
    </div>
    <div class="container w-full grid grid-cols-1 gap-x-8 gap-y-36 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4">
        {% for plant in plants %}
        <div class="card bg-green-950 p-10 pt-24 rounded-md relative">
            <img class="w-56 absolute -top-5 left-1/2 transform -translate-x-1/2 -translate-y-1/2 duration-500" src="{{ plant.image.url }}" alt="{{ plant.common_name }}">
            <p class="italic">{{ plant.scientific_name }}</p>
            <h3>{{ plant.common_name }}</h3>
            <div class="text-yellow-500 text-xs py-3">
                {% for i in "01234" %}
                    {% if forloop.counter <= plant.rating %}
                        <i class="fi fi-sc-star"></i>
                    {% else %}
                        <i class="fi fi-rr-star text-gray-300"></i>
                    {% endif %}
                {% endfor %}
            </div>
            <div class="flex items-center justify-between">
                <p class="text-xl">{{ plant.price }} RM</p>
                <button 
                class="bg-yellow-500 px-2 py-1 rounded-sm text-xl add-to-cart"
                data-plant-id="{{ plant.id }}"
            >
                <i class="fi fi-rr-shopping-cart"></i>
            </button>
            <div id="csrf-container">
                <input type="hidden" name="csrfmiddlewaretoken" value="{{ csrf_token }}">
            </div>
            
            </div>
        </div>
        {% endfor %}
    </div>
</section>
<script>
    document.addEventListener('DOMContentLoaded', function() {
    // Function to set a cookie
    function setCookie(name, value, days) {
        let expires = "";
        if (days) {
            let date = new Date();
            date.setTime(date.getTime() + (days * 24 * 60 * 60 * 1000));
            expires = "; expires=" + date.toUTCString();
        }
        document.cookie = name + "=" + (value || "") + expires + "; path=/";
    }

    // Function to get a cookie
    function getCookie(name) {
        let nameEQ = name + "=";
        let ca = document.cookie.split(';');
        for (let i = 0; i < ca.length; i++) {
            let c = ca[i];
            while (c.charAt(0) === ' ') c = c.substring(1, c.length);
            if (c.indexOf(nameEQ) === 0) return c.substring(nameEQ.length, c.length);
        }
        return null;
    }

    // Function to update cart badge
    function updateCartBadge() {
        let cart = JSON.parse(getCookie('cart')) || {};
        console.log('Cart:', cart);  // Debugging
        let totalQuantity = Object.values(cart).reduce((acc, quantity) => acc + quantity, 0);
        console.log('Total Quantity:', totalQuantity);  // Debugging

        let badgeElement = document.getElementById('cart-badge');
        if (badgeElement) {
            badgeElement.textContent = totalQuantity;
            console.log('Updated Badge Content:', badgeElement.textContent);  // Debugging
        } else {
            console.error('Cart badge element not found');  // Error handling
        }
    }

    // Initialize cart badge
    updateCartBadge();

    // Event listener for Add to Cart buttons
    document.querySelectorAll('.add-to-cart').forEach(button => {
        button.addEventListener('click', function() {
            const plantId = this.getAttribute('data-plant-id');
            console.log(plantId)
            let cart = JSON.parse(getCookie('cart')) || {};
            console.log(cart)
            if (cart[plantId]) {
                cart[plantId] += 1;  // Increase quantity if plant already in cart
            } else {
                cart[plantId] = 1;  // Add new plant with quantity 1
            }

            setCookie('cart', JSON.stringify(cart), 7); // Store cart in cookies for 7 days

            // Update cart badge immediately
            updateCartBadge();
        });
    });
});

</script>
{% endblock %}
